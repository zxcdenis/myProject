{% extends 'news_app/base.html' %}
{% load custom_tags  %}  
{% block content %}
<div class="container py-4">
    <div class="row g-4">
        <section id="news" class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                {% if filter_type == 'latest' %}        
                    <h2 class="mb-0">Последние новости</h2>
                {% endif %}
                {% if filter_type == 'tags' %}        
                    <h2 class="mb-0">Новости по Тегам</h2>
                {% endif %}
                {% if request.user|has_group:"Модераторы" %}
                    <a href="{% url 'add_news' %}" class="btn btn-outline-success">Добавить новость</a>
                {% endif %}
            </div>
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a href="{% url 'home' %}?filter=latest" class="nav-link {% if filter_type == 'latest' %}active{% endif %}">
                        <i class="fas fa-newspaper"></i> Последние
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'home' %}?filter=tags" class="nav-link {% if filter_type == 'tags' %}active{% endif %}">
                        <i class="fas fa-tags"></i> По тегам
                    </a>
                </li>
            </ul>
            <form method="get" action="{% url 'home' %}">
                <input type="hidden" name="filter" value="tags">
                <select name="tags" multiple>
                    {% for tag in all_tags %}
                    <option value="{{ tag.id }}" {% if tag.id|stringformat:"s" in selected_tags_ids %}selected{% endif %}>
                        {{ tag.name }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">Фильтровать</button>
            </form>
            
            {% for article in articles %}
            <div class="card mb-3 clickable-thread shadow-sm" data-href="{% url 'news_detail' article.id %}">
                <div class="card-body">

                    <h3 class="card-title">
                        <a href="{% url 'news_detail' article.id %}" class="text-decoration-none text-dark">{{ article.title }}</a>
                    </h3>
                    {% if article.image %}
                        <img src="{{ article.image.url }}" class="card-img-top" alt="{{ article.title }}">
                    {% endif %}


                    <p class="card-text">{{ article.content|truncatewords:30 }}</p>
                    <div class="text-muted">Дата Публикации: {{ article.published_date|date:"Y-m-d H:i" }}</div>
                    <div class="article-tags">
                        <strong>Теги:</strong>
                        {% for tag in article.tags.all %}
                            <span class="badge badge-warning">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                    <div class="text-muted">
                        <small>
                            {{ article.comments.count }}
                            {{ article.comments.count|russian_pluralize:"комментарий,комментария,комментариев" }}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
            <div class="mt-4">
                <a href="{% url 'all_news' %}" class="btn btn-outline-info">Больше новостей</a>
            </div>
            
        </section>

        <aside id="threads" class="col-lg-4 extra-padding-left">
            <h2 class="mb-3">Недавняя активность</h2>
            <a href="/add_thread/" class="btn btn-outline-primary mb-3">Добавить новое обсуждение</a>
            {% for thread in threads %}
            <div class="card mb-3 clickable-thread shadow-sm" data-href="{% url 'thread_detail' thread.id %}">
                <div class="card-body">
                    <h3 class="card-title">{{ thread.title }}</h3>
                    <div class="text-muted">
                        <small>Автор: {{ thread.author.username }}</small><br>
                        <small>Дата Публикации: {{ thread.published_date|date:"Y-m-d H:i" }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </aside>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    function createArticleHtml(article) {
        var html = '<div class="card mb-3 clickable-thread shadow-sm" data-href="' + article.detail_url + '">';
        html += '<div class="card-body">';
        html += '<h3 class="card-title"><a href="' + article.detail_url + '" class="text-decoration-none text-dark">' + article.title + '</a></h3>';
        if (article.image_url) {
            html += '<img src="' + article.image_url + '" class="card-img-top" alt="' + article.title + '">';
        }
        html += '<p class="card-text">' + article.content + '</p>';
        html += '<div class="text-muted">Дата Публикации: ' + article.published_date + '</div>';
        html += '<div class="article-tags"><strong>Теги:</strong>';
        article.tags.forEach(function(tag) {
            html += '<span class="badge badge-warning">' + tag + '</span>';
        });
        html += '</div>';
        html += '<div class="text-muted"><small>' + article.comments_count + ' комментариев</small></div>';
        html += '</div></div>';
        return html;
    }

    function toggleTagFilterDisplay() {
        var filter = new URLSearchParams(window.location.search).get('filter');
        console.log("Filter type:", filter);
        if (filter === 'tags') {
            $('form select[name="tags"]').closest('form').show();
            $('select[name="tags"]').select2({
                width: '100%',
                placeholder: 'Выберите теги'
            });
        } else {
            $('form select[name="tags"]').closest('form').hide();
        }
    }

    function filterArticles() {
        var urlParams = new URLSearchParams(window.location.search);
        var filter = urlParams.get('filter');
        var tags = urlParams.getAll('tags');

        $.ajax({
            url: "{% url 'home' %}",
            data: {
                filter: filter,
                tags: tags
            },
            dataType: 'json',
            success: function(data) {
                $('#news').empty();
                $.each(data.articles, function(i, article) {
                    $('#news').append(createArticleHtml(article));
                });
            }
        });
    }

    toggleTagFilterDisplay()
    
    $('.nav-tabs .nav-item .nav-link').on('click', function() {
        var selectedFilter = $(this).attr('href').split('=')[1];
        history.replaceState(null, '', '?filter=' + selectedFilter);
        toggleTagFilterDisplay();
        if (selectedFilter === 'latest') {
            filterArticles('latest', []); 
        } else {
            filterArticles('tags', $('select[name="tags"]').val());
        }
    });
</script>

{% endblock %}